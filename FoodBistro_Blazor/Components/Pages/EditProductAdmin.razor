@page "/adminEdit"

@rendermode InteractiveServer

@inject IProductService productService

<h3 class="text-center">Admin Panel - Manage Products</h3>

@if (products != null && products.Any())
{
    <div class="container mt-4">
        <div class="row">
            @foreach (var product in products)
            {
                <div class="col-12 mb-2">
                    <div class="card">
                        <div class="row g-0">
                            <div class="col-md-2">
                                <img src="@product.ImgUrl" class="img-fluid rounded-start" style="height: 100px; object-fit: cover;" alt="@product.Name">
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <div class="card-body">
                                    <h5 class="card-title">@product.Name</h5>
                                    <p class="card-text">Price: Rs. @product.Price</p>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-center justify-content-center">
                                <button class="btn btn-primary me-2" @onclick="() => EditProduct(product)">Edit</button>
                                <button class="btn btn-danger" @onclick="() => DeleteProduct(product.Id)">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    @if (isEditing)
    {
        <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-black">Edit Product</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="productName" class="form-label text-black">Product Name</label>
                            <input type="text" id="productName" class="form-control" @bind="selectedProduct.Name">
                        </div>
                        <div class="mb-3">
                            <label for="productPrice" class="form-label text-black">Price</label>
                            <input type="number" id="productPrice" class="form-control" @bind="selectedProduct.Price">
                        </div>
                        <div class="mb-3">
                            <label for="productImage" class="form-label text-black">Image URL</label>
                            <input type="text" id="productImage" class="form-control" @bind="selectedProduct.ImgUrl">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="button" class="btn btn-success" @onclick="SaveProduct">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="d-flex align-items-center justify-content-center col-lg-12">
        <p>No products found.</p>
    </div>
}

@code {
    private bool isEditing = false;
    private Product selectedProduct = new Product();

    private List<Product> products;

    protected override async Task OnInitializedAsync()
    {
        productService.OnChange += StateHasChanged;
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        products = await productService.GetProducts();
    }

    
    private void EditProduct(Product product)
    {
        selectedProduct = product;
        isEditing = true;
    }

    private async Task SaveProduct()
    {
        bool isUpdated = await productService.UpdateProductAsync(selectedProduct);
        if (isUpdated)
        {
            isEditing = false;
            await LoadProducts();
        }
    }

    private async Task DeleteProduct(int id)
    {
        bool isDeleted = await productService.DeleteProductAsync(id);
        if (isDeleted)
        {
            await LoadProducts();
        }
    }

    private void CloseModal()
    {
        isEditing = false;
        selectedProduct = new Product();
    }

    public void Dispose()
    {
        productService.OnChange -= StateHasChanged;
    }

}
